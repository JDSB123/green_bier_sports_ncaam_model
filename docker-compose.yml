# ═══════════════════════════════════════════════════════════════════════════════
# GREEN BIER SPORT VENTURES - NCAAM v6.3.1 FINAL
# ═══════════════════════════════════════════════════════════════════════════════
# Enterprise-ready sports prediction model with:
# - Dynamic port allocation (no conflicts with other sports)
# - Sport-parameterized database (multi-sport capable)
# - 6 independent market predictions (Spread/ML/Total x FG/1H)
# - Self-contained Docker secrets (no .env dependencies)
# ═══════════════════════════════════════════════════════════════════════════════

name: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}

# ─────────────────────────────────────────────────────────────────────────────────
# DOCKER SECRETS - ALL SECRETS FROM FILES (NO ENV VAR FALLBACKS)
# ─────────────────────────────────────────────────────────────────────────────────
secrets:
  db_password:
    file: ./secrets/db_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
  odds_api_key:
    file: ./secrets/odds_api_key.txt
  teams_webhook_url:
    file: ./secrets/teams_webhook_url.txt
  teams_webhook_secret:
    file: ./secrets/teams_webhook_secret.txt

x-common-env: &common-env
  environment:
    TZ: America/Chicago

x-security-opts: &security-opts
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL
  read_only: true

x-resource-limits: &resource-limits
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 512M
      reservations:
        cpus: '0.25'
        memory: 256M

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # DATA TIER
  # ─────────────────────────────────────────────────────────────────────────────

  postgres:
    image: timescale/timescaledb:latest-pg15
    container_name: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_postgres
    <<: *common-env
    secrets:
      - db_password
    environment:
      # Sport-parameterized database (enables multi-sport deployment)
      SPORT: ${SPORT:-ncaam}
      POSTGRES_DB: ${DB_NAME:-${SPORT:-ncaam}}
      POSTGRES_USER: ${DB_USER:-${SPORT:-ncaam}}
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      POSTGRES_INITDB_ARGS: "--auth-local=md5 --auth-host=scram-sha-256"
    volumes:
      - ncaam_v6_postgres_data:/var/lib/postgresql/data:rw
      - ./database/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - ncaam_v6_data
    ports:
      - "${POSTGRES_HOST_PORT:-5450}:5432"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-${SPORT:-ncaam}}"]
      <<: *healthcheck-defaults
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_redis
    <<: [*resource-limits, *security-opts]
    secrets:
      - redis_password
    command: >
      sh -c "redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save ''
      --stop-writes-on-bgsave-error no
      --requirepass $$(cat /run/secrets/redis_password)"
    networks:
      - ncaam_v6_data
    ports:
      - "${REDIS_HOST_PORT:-6390}:6379"
    tmpfs:
      - /tmp:noexec,nosuid,size=50M
    cap_add:
      - NET_BIND_SERVICE
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      <<: *healthcheck-defaults
    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────────────────────
  # THE MODEL - Self-Contained Prediction Service
  # ─────────────────────────────────────────────────────────────────────────────

  prediction-service:
    image: ncaamstableacr.azurecr.io/ncaam-prediction:v6.3.35
    container_name: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_prediction
    <<: [*common-env, *security-opts]
    secrets:
      - db_password
      - odds_api_key
      - redis_password
      - teams_webhook_url
      - teams_webhook_secret
    environment:
      # Sport-parameterized configuration (enables multi-sport deployment)
      SPORT: ${SPORT:-ncaam}
      DB_USER: ${DB_USER:-${SPORT:-ncaam}}
      DB_NAME: ${DB_NAME:-${SPORT:-ncaam}}
      DB_HOST: postgres
      DB_PORT: "5432"
      # All secrets read from /run/secrets/* files - NO ENV VAR FALLBACKS
      THE_ODDS_API_KEY_FILE: /run/secrets/odds_api_key
      DB_PASSWORD_FILE: /run/secrets/db_password
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      TEAMS_WEBHOOK_URL_FILE: /run/secrets/teams_webhook_url
      TEAMS_WEBHOOK_SECRET_FILE: /run/secrets/teams_webhook_secret
      # Model configuration (matches config.py defaults - single source of truth)
      # NOTE: POLL_INTERVAL_SECONDS is not used (manual-only mode, no polling)
      MODEL__HOME_COURT_ADVANTAGE_SPREAD: 3.2
      MODEL__HOME_COURT_ADVANTAGE_TOTAL: 0.0
    networks:
      - ncaam_v6_backend
      - ncaam_v6_data
    ports:
      - "${PREDICTION_HOST_PORT:-8092}:8082"
    volumes:
      # Optional CSV output target. Set PICKS_OUTPUT_HOST_DIR to your local OneDrive-synced
      # Teams "Shared Documents" folder for automatic upload to the channel.
      - "${PICKS_OUTPUT_HOST_DIR:-./predictions}:/app/output:rw"
    cap_add:
      - NET_BIND_SERVICE
    tmpfs:
      - /tmp:noexec,nosuid,size=100M
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8082/health', timeout=2).read()"]
      <<: *healthcheck-defaults
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────────────────────
  # RATINGS SYNC - Fetches Barttorvik ratings daily
  # ─────────────────────────────────────────────────────────────────────────────

  ratings-sync:
    build:
      context: ./services/ratings-sync-go
      dockerfile: ./Dockerfile
    image: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_ratings_sync:latest
    container_name: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_ratings_sync
    <<: [*common-env, *resource-limits]
    secrets:
      - db_password
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    environment:
      SPORT: ${SPORT:-ncaam}
      DB_USER: ${DB_USER:-${SPORT:-ncaam}}
      DB_NAME: ${DB_NAME:-${SPORT:-ncaam}}
      DB_HOST: postgres
      DB_PORT: "5432"
      # MANUAL-ONLY: Run once and exit (no automation)
      # User triggers via run_today.py when they want fresh picks
      RUN_ONCE: "${RATINGS_RUN_ONCE:-true}"
    networks:
      - ncaam_v6_data
    depends_on:
      postgres:
        condition: service_healthy
    cap_add:
      - NET_BIND_SERVICE
    tmpfs:
      - /tmp:noexec,nosuid,size=50M
    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────────────────────
  # MANUAL ODDS PULLS (NEVER AUTOMATED): Full-game then 1H
  # Run these one at a time via `docker compose run --rm ...`
  # ─────────────────────────────────────────────────────────────────────────────

  odds-full-once:
    build:
      context: ./services/odds-ingestion-rust
      dockerfile: ./Dockerfile
    image: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_odds_ingestion:latest
    container_name: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_odds_full_once
    <<: [*common-env, *security-opts, *resource-limits]
    secrets:
      - db_password
      - odds_api_key
      - redis_password
    environment:
      SPORT: ${SPORT:-ncaam}
      DB_USER: ${DB_USER:-${SPORT:-ncaam}}
      DB_NAME: ${DB_NAME:-${SPORT:-ncaam}}
      DB_HOST: postgres
      DB_PORT: "5432"
      # Odds config (full-game only)
      RUN_ONCE: "true"
      ENABLE_FULL: "true"
      ENABLE_H1: "false"
      ENABLE_H2: "false"
      REGIONS: "us"
      ODDS_FORMAT: "american"
      MARKETS_FULL: "spreads,totals,h2h"
    networks:
      - ncaam_v6_backend
      - ncaam_v6_data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    # One-shot: container exits after storing/publishing
    restart: "no"

  odds-1h-once:
    image: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_odds_ingestion:latest
    container_name: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_odds_h1_once
    <<: [*common-env, *security-opts, *resource-limits]
    secrets:
      - db_password
      - odds_api_key
      - redis_password
    environment:
      SPORT: ${SPORT:-ncaam}
      DB_USER: ${DB_USER:-${SPORT:-ncaam}}
      DB_NAME: ${DB_NAME:-${SPORT:-ncaam}}
      DB_HOST: postgres
      DB_PORT: "5432"
      # Odds config (first-half only)
      RUN_ONCE: "true"
      ENABLE_FULL: "false"
      ENABLE_H1: "true"
      ENABLE_H2: "false"
      REGIONS: "us"
      ODDS_FORMAT: "american"
      MARKETS_H1: "spreads_h1,totals_h1,h2h_h1"
      BOOKMAKERS_H1: "bovada,pinnacle,circa,bookmaker"
    networks:
      - ncaam_v6_backend
      - ncaam_v6_data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: "no"

volumes:
  ncaam_v6_postgres_data:
    name: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_postgres_data

networks:
  ncaam_v6_backend:
    name: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_backend
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_BACKEND_SUBNET:-10.51.2.0/24}

  ncaam_v6_data:
    name: ${COMPOSE_PROJECT_NAME:-ncaam_v6_model}_data
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_DATA_SUBNET:-10.51.3.0/24}
