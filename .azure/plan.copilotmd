# Azure Deployment Plan for green_bier_sports_ncaam_model Project

## Goal
Deploy the multi-service NCAAM application to Azure Container Apps using AZD and Bicep, with secure secret management, CI/CD, and managed database.

## Project Information
- Application: green_bier_sports_ncaam_model
- Technology Stack:
  - Rust (odds ingestion): services/odds-ingestion-rust
  - Python (prediction service): services/prediction-service-python
  - Go (ratings sync): services/ratings-sync-go
- Containerization: Dockerfiles provided for all services
- Data & Dependencies:
  - Relational database with migrations: database/migrations (PostgreSQL compatible)
  - Redis (password present in secrets/redis_password.txt)
  - External Odds API (key in secrets/odds_api_key.txt)
- Hosting Recommendation: Azure Container Apps (ACA) for serverless container execution (jobs and services)

## Azure Resources Architecture
```mermaid
flowchart LR
    subgraph Dev[Resource Group]
      ACR[Azure Container Registry]
      LA[Log Analytics]
      AI[Application Insights]
      KV[Azure Key Vault]
      PG[Azure Database for PostgreSQL]
      REDIS[Azure Cache for Redis]
      ENV[ACA Environment]
      RUST[ACA: odds-ingestion-rust]
      PY[ACA: prediction-service-python]
      GO[ACA: ratings-sync-go]
    end

    ACR --> RUST
    ACR --> PY
    ACR --> GO

    KV -- secrets --> RUST
    KV -- secrets --> PY
    KV -- secrets --> GO

    RUST -- ingest/store --> PG
    PY -- read/analyze --> PG
    GO -- sync/update --> PG

    RUST -- caching --> REDIS
    PY -- caching --> REDIS

    RUST -- logs --> LA
    PY -- logs --> LA
    GO -- logs --> LA

    LA --> AI
```

- Images are built and pushed to ACR; ACA pulls images using a managed identity with AcrPull.
- Secrets reside in Key Vault and are mapped to ACA container secrets/environment variables.
- PostgreSQL hosts application data; migrations run from the Python service.
- Redis provides caching for ingestion/prediction flows.
- Logs/metrics flow to Log Analytics and Application Insights.
- Ingress: only enabled if/when HTTP endpoints are exposed; current services likely run as background jobs.

## Recommended Azure Resources
- Compute: Azure Container Apps (three apps)
  - odds-ingestion-rust
    - Hosting: ACA (job or long-running container without ingress)
    - dockerFilePath: services/odds-ingestion-rust/Dockerfile
    - dockerContext: services/odds-ingestion-rust
    - Environment Variables (from KV/ACA secrets):
      - ODDS_API_KEY (Key Vault secret)
      - POSTGRES_CONNECTION (Key Vault secret)
      - REDIS_CONNECTION (Key Vault secret)
      - RUST_LOG (info/debug)
  - prediction-service-python
    - Hosting: ACA (scheduled job or on-demand task)
    - dockerFilePath: services/prediction-service-python/Dockerfile
    - dockerContext: services/prediction-service-python
    - Environment Variables:
      - POSTGRES_CONNECTION (Key Vault secret)
      - REDIS_CONNECTION (Key Vault secret)
      - ODDS_API_KEY (if used)
      - PYTHONUNBUFFERED=1
  - ratings-sync-go
    - Hosting: ACA (scheduled job)
    - dockerFilePath: services/ratings-sync-go/Dockerfile
    - dockerContext: services/ratings-sync-go
    - Environment Variables:
      - POSTGRES_CONNECTION (Key Vault secret)
      - GO_LOG_LEVEL (info/debug)

- Supporting Services
  - Container Registry: Standard SKU
  - ACA Environment: with Log Analytics workspace
  - Key Vault: Soft-delete + purge protection enabled
  - Azure Database for PostgreSQL Flexible Server: Burstable or General Purpose (size based on load)
  - Azure Cache for Redis: Basic/Standard (size based on cache footprint)
  - Log Analytics Workspace + Application Insights: telemetry and diagnostics

## Recommended Security Configurations
- Managed Identity (User-Assigned) for each ACA app
  - Grant AcrPull on ACR
  - Grant Key Vault secrets read on KV
  - Use database firewall rules or private endpoints; prefer VNet integration
- No plaintext secrets in repo; remove secrets/* after migration
- Enforce TLS; disable public network access where feasible (ACR/PG/Redis)

## Execution Steps (for Copilot)
1. Provision Infra and Deploy
   - Use mcp_azure_mcp_deploy `deploy_iac_rules_get` for ACA, container registry, key vault, postgres, redis.
   - Ensure Bicep under azure/ aligns with this plan; update as needed.
   - Validate Bicep with `az deployment group what-if` (or `azd provision --preview`).
   - Run `azd up` to provision and deploy initial ACA environment.
2. Images and App Config
   - Build and push images to ACR (GitHub Actions workflow).
   - Configure ACA apps with image references, env vars, and secrets from KV.
3. Data Migration
   - Create PostgreSQL DB; set connection string in KV.
   - Run database/migrations with services/prediction-service-python/run_migrations.py against Azure PG.
4. Observability
   - Wire ACA to Log Analytics and Application Insights; add baseline alerts.
5. Validation
   - Run ingestion/prediction jobs; confirm DB writes/reads, logs present; adjust scaling.

## Notes
- If any service exposes HTTP endpoints later, enable ACA ingress and set target port to match container.
- Consider scheduled jobs (ACA jobs) for batch workflows (ingestion, sync, prediction backfills).
