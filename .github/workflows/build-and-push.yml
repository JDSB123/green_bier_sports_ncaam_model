name: Build and Push to ACR

on:
  push:
    branches: [main]
    paths:
      - 'services/prediction-service-python/**'
      - 'services/ratings-sync-go/**'
      - 'services/odds-ingestion-rust/**'
      - 'services/web-frontend/**'
      - 'azure/**'
      - '.github/workflows/build-and-push.yml'

env:
  ACR_NAME: ncaamstablegbsvacr
  ACR_LOGIN_SERVER: ncaamstablegbsvacr.azurecr.io
  PRED_IMAGE: ncaam-prediction
  WEB_IMAGE: gbsv-web
  RATINGS_IMAGE: ncaam-ratings-sync
  ODDS_IMAGE: ncaam-odds-ingestion
  RESOURCE_GROUP: NCAAM-GBSV-MODEL-RG

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read VERSION file
        id: version
        run: |
          RAW_VERSION=$(cat VERSION | tr -d ' \n\r')
          if [ -z "$RAW_VERSION" ]; then
            echo "VERSION file is empty."
            exit 1
          fi
          TAG_VERSION="v${RAW_VERSION}"
          echo "raw=$RAW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $TAG_VERSION"

      - name: Pre-build validation
        run: |
          echo "Validating build requirements..."
          
          # Check VERSION file
          if [ ! -f VERSION ]; then
            echo "ERROR: VERSION file not found"
            exit 1
          fi
          
          # Check required directories
          for dir in services/prediction-service-python services/ratings-sync-go services/odds-ingestion-rust database/migrations database/seeds; do
            if [ ! -d "$dir" ]; then
              echo "ERROR: Required directory $dir not found"
              exit 1
            fi
          done
          
          # Check critical files
          for file in services/prediction-service-python/Dockerfile services/prediction-service-python/requirements.txt; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Required file $file not found"
              exit 1
            fi
          done
          
          echo "âœ… All pre-build checks passed"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Ensure Container Apps extension
        run: |
          az config set extension.use_dynamic_install=yes_without_prompt
          az extension add -n containerapp --yes || az extension update -n containerapp --yes

      - name: Build and push images
        run: |
          set -euo pipefail

          echo "Building and pushing images to $ACR_LOGIN_SERVER"

          # Prediction (hardened Dockerfile uses repo root context)
          echo "ðŸ”¨ Building prediction service..."
          docker build --no-cache \
            --progress=plain \
            -f services/prediction-service-python/Dockerfile \
            -t $ACR_LOGIN_SERVER/$PRED_IMAGE:${{ steps.version.outputs.tag }} \
            -t $ACR_LOGIN_SERVER/$PRED_IMAGE:latest \
            . 2>&1 | tee build-prediction.log
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ Prediction service build failed"
            tail -n 100 build-prediction.log
            exit 1
          fi

          docker push $ACR_LOGIN_SERVER/$PRED_IMAGE:${{ steps.version.outputs.tag }}
          docker push $ACR_LOGIN_SERVER/$PRED_IMAGE:latest

          # Web
          echo "ðŸ”¨ Building web frontend..."
          docker build --no-cache \
            --progress=plain \
            -f services/web-frontend/Dockerfile \
            -t $ACR_LOGIN_SERVER/$WEB_IMAGE:${{ steps.version.outputs.tag }} \
            -t $ACR_LOGIN_SERVER/$WEB_IMAGE:latest \
            services/web-frontend

          docker push $ACR_LOGIN_SERVER/$WEB_IMAGE:${{ steps.version.outputs.tag }}
          docker push $ACR_LOGIN_SERVER/$WEB_IMAGE:latest

          # Ratings sync
          echo "ðŸ”¨ Building ratings sync..."
          docker build --no-cache \
            --progress=plain \
            -f services/ratings-sync-go/Dockerfile \
            -t $ACR_LOGIN_SERVER/$RATINGS_IMAGE:${{ steps.version.outputs.tag }} \
            -t $ACR_LOGIN_SERVER/$RATINGS_IMAGE:latest \
            services/ratings-sync-go

          docker push $ACR_LOGIN_SERVER/$RATINGS_IMAGE:${{ steps.version.outputs.tag }}
          docker push $ACR_LOGIN_SERVER/$RATINGS_IMAGE:latest

          # Odds ingestion
          echo "ðŸ”¨ Building odds ingestion..."
          docker build --no-cache \
            --progress=plain \
            -f services/odds-ingestion-rust/Dockerfile \
            -t $ACR_LOGIN_SERVER/$ODDS_IMAGE:${{ steps.version.outputs.tag }} \
            -t $ACR_LOGIN_SERVER/$ODDS_IMAGE:latest \
            services/odds-ingestion-rust

          docker push $ACR_LOGIN_SERVER/$ODDS_IMAGE:${{ steps.version.outputs.tag }}
          docker push $ACR_LOGIN_SERVER/$ODDS_IMAGE:latest
          
          echo "âœ… All images built and pushed successfully"

      - name: Deploy to Azure Container Apps (best-effort)
        run: |
          echo "ðŸš€ Deploying to Azure Container Apps..."
          
          # Prediction API
          echo "Updating prediction service..."
          az containerapp update \
            --name ncaam-stable-prediction \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/${{ env.PRED_IMAGE }}:${{ steps.version.outputs.tag }} \
            --output none && echo "âœ… Prediction service updated" || echo "âš ï¸ Prediction Container App not found or update failed. Skipping."

          # Web
          echo "Updating web frontend..."
          az containerapp update \
            --name ncaam-stable-web \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/${{ env.WEB_IMAGE }}:${{ steps.version.outputs.tag }} \
            --output none && echo "âœ… Web frontend updated" || echo "âš ï¸ Web Container App not found or update failed. Skipping."

          # Manual jobs
          echo "Updating ratings sync job..."
          az containerapp job update \
            --name ncaam-stable-ratings-sync \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/${{ env.RATINGS_IMAGE }}:${{ steps.version.outputs.tag }} \
            --output none && echo "âœ… Ratings sync updated" || echo "âš ï¸ Ratings job not found or update failed. Skipping."

          echo "Updating odds ingestion job..."
          az containerapp job update \
            --name ncaam-stable-odds-ingestion \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/${{ env.ODDS_IMAGE }}:${{ steps.version.outputs.tag }} \
            --output none && echo "âœ… Odds ingestion updated" || echo "âš ï¸ Odds ingestion job not found or update failed. Skipping."
          
          echo "âœ… Deployment phase complete"

      - name: Update docker-compose.yml with new prediction-service version
        run: |
          echo "ðŸ“ Updating docker-compose.yml with new version..."
          sed -i "s|image: .*/$PRED_IMAGE:.*|image: $ACR_LOGIN_SERVER/$PRED_IMAGE:${{ steps.version.outputs.tag }}|" docker-compose.yml
          echo "âœ… docker-compose.yml updated"

      - name: Commit updated docker-compose.yml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docker-compose.yml
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "CI: Update prediction-service image to ${{ steps.version.outputs.tag }}"
            git push
            echo "âœ… Changes committed and pushed"
          fi

      - name: Summary
        run: |
          echo "## âœ… Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.version.outputs.tag }} (raw: ${{ steps.version.outputs.raw }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images Built & Pushed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Prediction:** \`${{ env.ACR_LOGIN_SERVER }}/${{ env.PRED_IMAGE }}:${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Web:** \`${{ env.ACR_LOGIN_SERVER }}/${{ env.WEB_IMAGE }}:${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Ratings Job:** \`${{ env.ACR_LOGIN_SERVER }}/${{ env.RATINGS_IMAGE }}:${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Odds Job:** \`${{ env.ACR_LOGIN_SERVER }}/${{ env.ODDS_IMAGE }}:${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Python imports validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Compiled binaries verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "If infrastructure isn't deployed yet, run \`azure/deploy.ps1\` first." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Build completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY

