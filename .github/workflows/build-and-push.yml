name: Build and Push to ACR

on:
  push:
    branches: [main]
    paths:
      - 'services/prediction-service-python/**'
      - 'services/ratings-sync-go/**'
      - 'services/odds-ingestion-rust/**'
      - 'services/web-frontend/**'
      - 'azure/**'
      - '.github/workflows/build-and-push.yml'

env:
  ACR_NAME: ncaamgbsvacr
  ACR_LOGIN_SERVER: ncaamgbsvacr.azurecr.io
  PRED_IMAGE: ncaam-prediction
  WEB_IMAGE: gbsv-web
  RATINGS_IMAGE: ncaam-ratings-sync
  ODDS_IMAGE: ncaam-odds-ingestion
  RESOURCE_GROUP: ncaam-gbsv-model

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version from commit
        id: version
        run: |
          # Generate version: v6.3.{25 + run_number} to continue from v6.3.25
          VERSION="v6.3.$((25 + ${{ github.run_number }}))"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push images
        run: |
          set -euo pipefail

          echo "Building and pushing images to $ACR_LOGIN_SERVER"

          # Prediction (hardened Dockerfile uses repo root context)
          docker build --no-cache \
            -f services/prediction-service-python/Dockerfile.hardened \
            -t $ACR_LOGIN_SERVER/$PRED_IMAGE:${{ steps.version.outputs.version }} \
            -t $ACR_LOGIN_SERVER/$PRED_IMAGE:latest \
            .

          docker push $ACR_LOGIN_SERVER/$PRED_IMAGE:${{ steps.version.outputs.version }}
          docker push $ACR_LOGIN_SERVER/$PRED_IMAGE:latest

          # Web
          docker build --no-cache \
            -f services/web-frontend/Dockerfile \
            -t $ACR_LOGIN_SERVER/$WEB_IMAGE:${{ steps.version.outputs.version }} \
            -t $ACR_LOGIN_SERVER/$WEB_IMAGE:latest \
            services/web-frontend

          docker push $ACR_LOGIN_SERVER/$WEB_IMAGE:${{ steps.version.outputs.version }}
          docker push $ACR_LOGIN_SERVER/$WEB_IMAGE:latest

          # Ratings sync
          docker build --no-cache \
            -f services/ratings-sync-go/Dockerfile \
            -t $ACR_LOGIN_SERVER/$RATINGS_IMAGE:${{ steps.version.outputs.version }} \
            -t $ACR_LOGIN_SERVER/$RATINGS_IMAGE:latest \
            services/ratings-sync-go

          docker push $ACR_LOGIN_SERVER/$RATINGS_IMAGE:${{ steps.version.outputs.version }}
          docker push $ACR_LOGIN_SERVER/$RATINGS_IMAGE:latest

          # Odds ingestion
          docker build --no-cache \
            -f services/odds-ingestion-rust/Dockerfile \
            -t $ACR_LOGIN_SERVER/$ODDS_IMAGE:${{ steps.version.outputs.version }} \
            -t $ACR_LOGIN_SERVER/$ODDS_IMAGE:latest \
            services/odds-ingestion-rust

          docker push $ACR_LOGIN_SERVER/$ODDS_IMAGE:${{ steps.version.outputs.version }}
          docker push $ACR_LOGIN_SERVER/$ODDS_IMAGE:latest

      - name: Deploy to Azure Container Apps (best-effort)
        run: |
          # Prediction API
          az containerapp update \
            --name ncaam-gbsv-prediction \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/${{ env.PRED_IMAGE }}:${{ steps.version.outputs.version }} \
            --output none || echo "Prediction Container App not found or update failed. Skipping."

          # Web
          az containerapp update \
            --name ncaam-gbsv-web \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/${{ env.WEB_IMAGE }}:${{ steps.version.outputs.version }} \
            --output none || echo "Web Container App not found or update failed. Skipping."

          # Manual jobs
          az containerapp job update \
            --name ncaam-gbsv-ratings-sync \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/${{ env.RATINGS_IMAGE }}:${{ steps.version.outputs.version }} \
            --output none || echo "Ratings job not found or update failed. Skipping."

          az containerapp job update \
            --name ncaam-gbsv-odds-ingestion \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/${{ env.ODDS_IMAGE }}:${{ steps.version.outputs.version }} \
            --output none || echo "Odds ingestion job not found or update failed. Skipping."

      - name: Update docker-compose.yml with new prediction-service version
        run: |
          sed -i "s|image: ncaamgbsvacr.azurecr.io/ncaam-prediction:.*|image: ncaamgbsvacr.azurecr.io/ncaam-prediction:${{ steps.version.outputs.version }}|" docker-compose.yml

      - name: Commit updated docker-compose.yml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docker-compose.yml
          git diff --staged --quiet || git commit -m "CI: Update prediction-service image to ${{ steps.version.outputs.version }}"
          git push

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Prediction:** ${{ env.ACR_LOGIN_SERVER }}/${{ env.PRED_IMAGE }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Web:** ${{ env.ACR_LOGIN_SERVER }}/${{ env.WEB_IMAGE }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ratings Job:** ${{ env.ACR_LOGIN_SERVER }}/${{ env.RATINGS_IMAGE }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Odds Job:** ${{ env.ACR_LOGIN_SERVER }}/${{ env.ODDS_IMAGE }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If infra isn't deployed yet, run \`azure/deploy.ps1\` first." >> $GITHUB_STEP_SUMMARY
