name: Sync Historical Data

# Run on file changes, weekly schedule, or manual trigger
on:
  push:
    branches: [main]
    paths:
      - 'ncaam_historical_data_local/**'
      - 'testing/scripts/fetch_historical_*.py'
      - 'testing/scripts/canonicalize_*.py'
  schedule:
    # Run every Sunday at 6 AM UTC (midnight CST)
    - cron: '0 6 * * 0'
  workflow_dispatch:  # Allow manual triggering
    inputs:
      sync_raw_to_azure:
        description: 'Sync raw data to Azure Blob Storage'
        required: false
        default: true
        type: boolean
      include_ncaahoopR:
        description: 'Include ncaahoopR data (6.7 GB - use sparingly)'
        required: false
        default: false
        type: boolean

env:
  STORAGE_ACCOUNT: metricstrackersgbsv
  CONTAINER_NAME: ncaam-historical-raw
  HISTORICAL_DATA_REPO: JDSB123/ncaam-historical-data

jobs:
  check-sync-status:
    runs-on: ubuntu-latest
    outputs:
      needs_sync: ${{ steps.check.outputs.needs_sync }}
    
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4

      - name: Check if historical data submodule has changes
        id: check
        run: |
          # Check if ncaam_historical_data_local exists and has git
          if [ -d "ncaam_historical_data_local/.git" ]; then
            cd ncaam_historical_data_local
            # Check for uncommitted changes
            if [ -n "$(git status --porcelain)" ]; then
              echo "needs_sync=true" >> $GITHUB_OUTPUT
              echo "üì¶ Historical data has uncommitted changes"
            else
              echo "needs_sync=false" >> $GITHUB_OUTPUT
              echo "‚úÖ Historical data is clean"
            fi
          else
            echo "needs_sync=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Historical data directory not found or not a git repo"
          fi

  sync-historical-data-repo:
    needs: check-sync-status
    runs-on: ubuntu-latest
    if: needs.check-sync-status.outputs.needs_sync == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout main repo with historical data
        uses: actions/checkout@v4
        with:
          # Use HISTORICAL_DATA_PAT if available, otherwise use default GITHUB_TOKEN
          token: ${{ secrets.HISTORICAL_DATA_PAT || github.token }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Push historical data changes
        env:
          HAS_PAT: ${{ secrets.HISTORICAL_DATA_PAT != '' }}
        run: |
          if [ -d "ncaam_historical_data_local/.git" ]; then
            cd ncaam_historical_data_local
            
            # Check for changes
            if [ -n "$(git status --porcelain)" ]; then
              git add -A
              git commit -m "chore: auto-sync from main repo [skip ci]" || true
              
              if [ "$HAS_PAT" = "true" ]; then
                git push origin master
                echo "‚úÖ Historical data pushed to ncaam-historical-data repo"
              else
                echo "‚ö†Ô∏è HISTORICAL_DATA_PAT not configured - cannot push to external repo"
                echo "To enable: Add a GitHub PAT with repo access to JDSB123/ncaam-historical-data as HISTORICAL_DATA_PAT secret"
              fi
            else
              echo "No changes to push"
            fi
          else
            echo "‚ö†Ô∏è ncaam_historical_data_local/.git not found - this is expected in CI"
            echo "Historical data is synced locally, not as a submodule"
          fi

  sync-raw-to-azure:
    runs-on: ubuntu-latest
    if: github.event.inputs.sync_raw_to_azure == 'true' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install azure-storage-blob

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Sync raw data to Azure Blob
        env:
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
        run: |
          if [ -d "ncaam_historical_data_local/odds/raw/archive" ]; then
            echo "Syncing raw odds archive to Azure Blob..."
            
            INCLUDE_NCAAHOPR=""
            if [ "${{ github.event.inputs.include_ncaahoopR }}" == "true" ]; then
              INCLUDE_NCAAHOPR="--include-ncaahoopR"
            fi
            
            python scripts/sync_raw_data_to_azure.py $INCLUDE_NCAAHOPR
          else
            echo "‚ö†Ô∏è No raw data directory found"
          fi

  notify-sync-complete:
    needs: [sync-historical-data-repo, sync-raw-to-azure]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Sync Summary
        run: |
          echo "üìä Historical Data Sync Summary"
          echo "================================"
          echo "Timestamp: $(date -u)"
          echo "Historical Repo Sync: ${{ needs.sync-historical-data-repo.result }}"
          echo "Azure Blob Sync: ${{ needs.sync-raw-to-azure.result }}"
