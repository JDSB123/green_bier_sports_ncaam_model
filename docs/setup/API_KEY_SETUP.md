# API Key & Secrets Setup Guide

**Status:** All environments now use unified secret management  
**Last Updated:** January 9, 2026

This guide covers setting up secrets for local development, Docker containers, and Azure Cloud deployments.

---

## ðŸŽ¯ Quick Start

### For Local Development (Windows PowerShell)

```powershell
# Set The Odds API key as environment variable
$env:THE_ODDS_API_KEY = "your_actual_key_here"

# Or create local file (recommended for local dev)
$key = "your_actual_key_here"
$key | Out-File -FilePath secrets/odds_api_key.txt -NoNewline -Encoding utf8
```

### For Docker Container

The `docker-compose.yml` automatically mounts secrets from the `secrets/` directory:

```bash
# File is automatically read from /run/secrets/odds_api_key inside container
secrets/odds_api_key.txt â†’ /run/secrets/odds_api_key
```

### For Azure Container Apps

Set environment variables in your deployment:

```bash
az containerapp update \
  --name ncaam-prediction \
  --resource-group NCAAM-GBSV-MODEL-RG \
  --set-env-vars THE_ODDS_API_KEY="your_actual_key"
```

---

## ðŸ“‹ All Secrets Required

The following secrets must be set up for the system to run:

| Secret | Type | Required | Location |
|--------|------|----------|----------|
| `THE_ODDS_API_KEY` | API Key | âœ… YES | [Get from here](https://the-odds-api.com/) |
| `DB_PASSWORD` | Database | âœ… YES | Generated by `ensure_secrets.py` |
| `REDIS_PASSWORD` | Cache | âœ… YES | Generated by `ensure_secrets.py` |
| `BASKETBALL_API_KEY` | API Key | âŒ Optional | [Get from here](https://api-basketball.com/) |
| `TEAMS_WEBHOOK_SECRET` | Webhook | âŒ Optional | Teams Outgoing Webhook (validates Teams â†’ API requests) |

---

## ðŸ”„ Priority Order (What Gets Used)

All secrets use **the same 3-tier priority system**:

```
1. âœ… ENVIRONMENT VARIABLE (wins if set)
   â””â”€ Used by: All environments (local, Docker, Azure)
   â””â”€ Set with: $env:VARIABLE=value (PowerShell)
   
2. ðŸ³ DOCKER SECRET FILE (if no env var)
   â””â”€ Location: /run/secrets/odds_api_key
   â””â”€ Used by: Docker containers only
   
3. ðŸ“„ LOCAL SECRETS FILE (if no env var or Docker secret)
   â””â”€ Location: secrets/odds_api_key.txt
   â””â”€ Used by: Local development only
```

**Example:** If you set `THE_ODDS_API_KEY` environment variable, it will be used everywhere (local, Docker, Azure) even if the local file exists.

---

## âš™ï¸ Setup Methods

### Method 1: Use `ensure_secrets.py` (Easiest)

**Recommended for local development.**

```powershell
# Generates secure random passwords for DB and Redis
python ensure_secrets.py
```

Then manually add The Odds API key:

```powershell
# Get your key from https://the-odds-api.com/
$apiKey = "your_actual_key_here"
$apiKey | Out-File -FilePath secrets/odds_api_key.txt -NoNewline -Encoding utf8
```

---

### Method 2: Environment Variables (Recommended for Azure)

**Best for cloud deployments and CI/CD.**

```powershell
# PowerShell (Windows)
$env:THE_ODDS_API_KEY = "your_key_here"
$env:DB_PASSWORD = "your_password_here"
$env:REDIS_PASSWORD = "your_password_here"

# Or permanent (current session + child processes)
[System.Environment]::SetEnvironmentVariable("THE_ODDS_API_KEY", "your_key_here", "User")
```

```bash
# Bash/Linux/Mac
export THE_ODDS_API_KEY="your_key_here"
export DB_PASSWORD="your_password_here"
export REDIS_PASSWORD="your_password_here"
```

---

### Method 3: Docker Secrets (For docker-compose)

The `docker-compose.yml` reads from local files and mounts them as Docker secrets:

```yaml
services:
  prediction:
    secrets:
      - odds_api_key
      - db_password
      - redis_password

secrets:
  odds_api_key:
    file: ./secrets/odds_api_key.txt
  db_password:
    file: ./secrets/db_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
```

**No configuration needed!** Just create the files in `secrets/` directory.

---

### Method 4: Azure Key Vault (Production Recommended)

**Best for production deployments.**

Store secrets in Azure Key Vault and reference them in Container Apps:

```bash
# Create secret in Key Vault
az keyvault secret set \
  --vault-name ncaam-keyvault \
  --name the-odds-api-key \
  --value "your_actual_key"

# Reference in Container App
az containerapp create \
  --name ncaam-prediction \
  --resource-group NCAAM-GBSV-MODEL-RG \
  --image myregistry.azurecr.io/ncaam-prediction:latest \
  --secrets \
    odds_api_key=keyvault:the-odds-api-key \
  --env-vars THE_ODDS_API_KEY=@odds_api_key
```

---

## ðŸ” Verification

### Check which secret is being used:

The system logs which source provided the secret (when debug logging enabled):

```python
# Code automatically detects and uses:
from secrets_manager import get_api_key

api_key = get_api_key("odds")  # Tells you which source was used
```

### List environment variables:

```powershell
# Show all NCAAM-related env vars
dir env: | Where-Object Name -Match "^(DB_|REDIS_|THE_ODDS)" | Select-Object Name, Value
```

### Check local files exist:

```powershell
# Show which secrets files exist locally
Get-ChildItem secrets/*.txt -ErrorAction SilentlyContinue | Select-Object Name
```

---

## ðŸ†˜ Troubleshooting

### Error: "MISSING REQUIRED SECRET: THE_ODDS_API_KEY"

**Cause:** API key not found in any of 3 sources.

**Fix:** Pick one method above and set it:

```powershell
# Option 1: Environment variable (quickest for testing)
$env:THE_ODDS_API_KEY = "your_key_from_https://the-odds-api.com"

# Option 2: Local file (for persistent local dev)
"your_key_from_https://the-odds-api.com" | Out-File -Path secrets/odds_api_key.txt -NoNewline -Encoding utf8
```

### Error: "Failed to read Docker secret..."

**Cause:** Running Docker but secret file missing.

**Fix:** 
- Local: Create `secrets/odds_api_key.txt`
- Or set env var: `$env:THE_ODDS_API_KEY = "your_key"`

### Error: "Permission denied" on secrets file

**Cause:** File has restrictive permissions.

**Fix (Windows):**

```powershell
# Reset file permissions
icacls secrets/odds_api_key.txt /inheritance:r /grant:r "$($env:USERNAME):F"
```

---

## ðŸ“Š Common Scenarios

### Scenario 1: Local Development

```powershell
# One-time setup
python ensure_secrets.py  # Creates DB and Redis passwords

# Add API key
$env:THE_ODDS_API_KEY = "your_key_here"

# Run locally
python testing/scripts/fetch_historical_odds.py --season 2025
```

### Scenario 2: Docker Local Testing

```powershell
# Setup once
python ensure_secrets.py
"your_key_here" | Out-File -Path secrets/odds_api_key.txt -NoNewline

# Run via Docker
docker-compose up prediction-service
```

### Scenario 3: Azure Cloud Deployment

```bash
# Set in Key Vault (once)
az keyvault secret set \
  --vault-name ncaam-keyvault \
  --name the-odds-api-key \
  --value "your_key_here"

# Deploy Container App (references Key Vault automatically)
./azure/deploy.ps1
```

### Scenario 4: CI/CD Pipeline (GitHub Actions)

```yaml
# .github/workflows/your-workflow.yml
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run tests
        env:
          THE_ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}  # from GitHub Secrets
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: python -m pytest
```

---

## ðŸ” Security Best Practices

âœ… **DO:**
- Store API keys in GitHub Secrets for CI/CD
- Use Azure Key Vault for production
- Rotate keys every 90 days
- Keep local files in `secrets/` (already in .gitignore)
- Use environment variables for short-lived processes

âŒ **DON'T:**
- Commit `secrets/*.txt` files to git
- Hardcode API keys in code
- Log or print API keys
- Use same key across environments
- Share secrets via chat/email

---

## ðŸ“ž Need Help?

1. **Check [ERROR] message** - it tells you exactly what's missing
2. **Verify source** - use troubleshooting section above
3. **Check priority** - remember: env var > Docker secret > local file
4. **File location** - must be `secrets/odd_api_key.txt` (no path needed)

---

## ðŸ“š Related Documentation

- [secrets/README.md](secrets/README.md) - Detailed secrets directory info
- [Testing Scripts](testing/scripts/) - All data ingestion scripts
- [Docker Setup](docker-compose.yml) - Container configuration
- [Azure Deployment](azure/README.md) - Cloud deployment guide
